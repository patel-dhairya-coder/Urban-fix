{% extends "admin_dashboard/base.html" %}

{% block title %}Complaint List{% endblock %}
{% block page_title %}Complaint Management{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">All Complaints</h2>

    <form method="GET" action="{% url 'admin_dashboard:complaint_list' %}" class="mb-6 flex flex-wrap gap-4 items-center">
        <div class="flex-grow">
            <label for="search" class="sr-only">Search</label>
            <input type="text" id="search" name="search" placeholder="Search by Report ID, Category, User..."
                   class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                   value="{{ search_query|default:'' }}">
        </div>

        <div>
            <label for="category" class="sr-only">Filter by Category</label>
            <select id="category" name="category"
                    class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                <option value="">All Categories</option>
                {% for key, value in categories %}
                    <option value="{{ key }}" {% if selected_category == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="status" class="sr-only">Filter by Status</label>
            <select id="status" name="status"
                    class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                <option value="">All Statuses</option>
                {% for key, value in statuses %}
                    <option value="{{ key }}" {% if selected_status == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
            Filter & Search
        </button>
        <a href="{% url 'admin_dashboard:complaint_list' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md">
            Reset
        </a>
    </form>

    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200">
            <thead>
                <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 text-left">Report ID</th>
                    <th class="py-3 px-6 text-left">User</th>
                    <th class="py-3 px-6 text-left">Category</th>
                    <th class="py-3 px-6 text-left">Location</th>
                    <th class="py-3 px-6 text-left">Submitted At</th>
                    <th class="py-3 px-6 text-center">Status</th>
                    <th class="py-3 px-6 text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="text-gray-700 text-sm font-light">
                {% for complaint in complaints %}
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-3 px-6 text-left whitespace-nowrap">
                        <a href="{% url 'admin_dashboard:complaint_detail' report_id=complaint.report_id %}" class="text-blue-600 hover:underline">
                            {{ complaint.report_id }}
                        </a>
                    </td>
                    <td class="py-3 px-6 text-left">{{ complaint.user.username }}</td>
                    <td class="py-3 px-6 text-left">{{ complaint.get_category_display }}</td>
                    <td class="py-3 px-6 text-left">{{ complaint.location }}</td>
                    <td class="py-3 px-6 text-left">{{ complaint.submitted_at|date:"M d, Y H:i" }}</td>
                    <td class="py-3 px-6 text-center">
                        {% if complaint.status == 'pending' %}
                            <span class="bg-yellow-200 text-yellow-800 py-1 px-3 rounded-full text-xs">{{ complaint.get_status_display }}</span>
                        {% elif complaint.status == 'in_progress' %}
                            <span class="bg-blue-200 text-blue-800 py-1 px-3 rounded-full text-xs">{{ complaint.get_status_display }}</span>
                        {% elif complaint.status == 'resolved' %}
                            <span class="bg-green-200 text-green-800 py-1 px-3 rounded-full text-xs">{{ complaint.get_status_display }}</span>
                        {% elif complaint.status == 'rejected' %}
                            <span class="bg-red-200 text-red-800 py-1 px-3 rounded-full text-xs">{{ complaint.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center space-x-2">
                            <a href="{% url 'admin_dashboard:complaint_detail' report_id=complaint.report_id %}" title="View Details" class="w-4 transform hover:text-blue-500 hover:scale-110">
                                <i class="fas fa-eye"></i>
                            </a>
                            <form action="{% url 'admin_dashboard:delete_complaint' report_id=complaint.report_id %}" method="POST" class="inline-block" onsubmit="return confirm('Are you sure you want to delete this complaint? This action cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" title="Delete Complaint" class="w-4 h-4 transform hover:text-red-500 hover:scale-110">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                            </div>
                    </td>
                    </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="py-3 px-6 text-center text-gray-500">No complaints found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}